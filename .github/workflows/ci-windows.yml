name: CI Windows

on:
  push:
    branches: [main]
    paths:
      - 'platforms/windows/**'
      - '.github/workflows/ci-windows.yml'
    tags-ignore:
      - 'v*'
  pull_request:
    branches: [main]
    paths:
      - 'platforms/windows/**'
      - '.github/workflows/ci-windows.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  build:
    name: Build & Test
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Restore dependencies
        run: dotnet restore platforms/windows/PortKiller/PortKiller.csproj

      - name: Build (Debug)
        run: dotnet build platforms/windows/PortKiller/PortKiller.csproj -c Debug --no-restore

      - name: Build (Release x64)
        run: dotnet publish platforms/windows/PortKiller/PortKiller.csproj -c Release -r win-x64 --self-contained false

      - name: Build (Release arm64)
        run: dotnet publish platforms/windows/PortKiller/PortKiller.csproj -c Release -r win-arm64 --self-contained false

      - name: Verify build outputs
        run: |
          Write-Host "Checking build outputs..."

          # Find the actual publish directories
          $x64Exe = Get-ChildItem -Path platforms/windows/PortKiller -Recurse -Filter "PortKiller.exe" | Where-Object { $_.FullName -like "*win-x64*" } | Select-Object -First 1
          $arm64Exe = Get-ChildItem -Path platforms/windows/PortKiller -Recurse -Filter "PortKiller.exe" | Where-Object { $_.FullName -like "*win-arm64*" } | Select-Object -First 1

          if ($x64Exe) {
            Write-Host "x64 build exists: $($x64Exe.FullName)"
            $size = $x64Exe.Length / 1MB
            Write-Host "  Size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "x64 build missing!"
            exit 1
          }

          if ($arm64Exe) {
            Write-Host "arm64 build exists: $($arm64Exe.FullName)"
            $size = $arm64Exe.Length / 1MB
            Write-Host "  Size: $([math]::Round($size, 2)) MB"
          } else {
            Write-Error "arm64 build missing!"
            exit 1
          }

      - name: Create test packages
        run: |
          # Create directories for artifacts
          New-Item -ItemType Directory -Force -Path artifacts/win-x64
          New-Item -ItemType Directory -Force -Path artifacts/win-arm64

          # Copy x64 build
          $x64Publish = Get-ChildItem -Path platforms/windows/PortKiller -Recurse -Directory | Where-Object { $_.FullName -like "*win-x64*publish*" } | Select-Object -First 1
          if ($x64Publish) {
            Copy-Item -Path "$($x64Publish.FullName)/*" -Destination artifacts/win-x64 -Recurse
          }

          # Copy arm64 build
          $arm64Publish = Get-ChildItem -Path platforms/windows/PortKiller -Recurse -Directory | Where-Object { $_.FullName -like "*win-arm64*publish*" } | Select-Object -First 1
          if ($arm64Publish) {
            Copy-Item -Path "$($arm64Publish.FullName)/*" -Destination artifacts/win-arm64 -Recurse
          }

      - name: Upload x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: PortKiller-windows-x64
          path: artifacts/win-x64
          retention-days: 7

      - name: Upload arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: PortKiller-windows-arm64
          path: artifacts/win-arm64
          retention-days: 7

      - name: Comment on PR with download links
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const body = `## ðŸ§ª Windows Test Builds Ready!

            | Platform | Download |
            |----------|----------|
            | Windows x64 | [PortKiller-windows-x64](${runUrl}#artifacts) |
            | Windows ARM64 | [PortKiller-windows-arm64](${runUrl}#artifacts) |

            > **Note:** Requires [.NET 9 Runtime](https://dotnet.microsoft.com/download/dotnet/9.0) to run.
            > Artifacts expire in 7 days.

            ---
            <sub>ðŸ¤– Auto-generated by CI</sub>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c => c.body.includes('Windows Test Builds Ready'));

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
